<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Planta - Detecci√≥n IA</title>
  
  <!-- TensorFlow.js y COCO-SSD -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      background: #000;
    }

    /* Contenedor principal */
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Video de la c√°mara */
    #camera {
      position: absolute;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* Canvas para dibujar las detecciones */
    #canvas {
      position: absolute;
      max-width: 100%;
      max-height: 100%;
    }

    /* Header */
    .header {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      padding: 12px 24px;
      border-radius: 20px;
      border: 1px solid rgba(2, 238, 240, 0.3);
      text-align: center;
      max-width: 90%;
    }
    .header h1 {
      color: #02eef0;
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 4px 0;
    }
    .header .status {
      color: #9fb4c9;
      font-size: 11px;
    }
    .header .status.detecting {
      color: #6bcf7f;
    }

    /* Contenedor de datos (se posiciona din√°micamente cerca de la planta) */
    .data-panel {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      border: 2px solid #02eef0;
      border-radius: 16px;
      padding: 16px;
      min-width: 200px;
      box-shadow: 0 4px 30px rgba(2, 238, 240, 0.3);
      display: none; /* Oculto por defecto */
      z-index: 50;
    }
    .data-panel.visible {
      display: block;
    }

    .data-panel .title {
      color: #02eef0;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .data-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    .data-row .label {
      color: #9fb4c9;
      font-size: 12px;
    }
    .data-row .value {
      color: #fff;
      font-size: 14px;
      font-weight: 700;
    }

    /* Mensaje de carga */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 200;
      background: rgba(0, 0, 0, 0.95);
      color: #02eef0;
      padding: 24px 32px;
      border-radius: 16px;
      text-align: center;
      font-size: 16px;
      border: 1px solid #02eef0;
    }
    .loading.hidden { display: none; }

    /* Instrucciones */
    .instructions {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      background: rgba(2, 238, 240, 0.9);
      color: #000;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      max-width: 90%;
      text-align: center;
    }
  </style>
</head>
<body>

  <div class="header">
    <h1 id="plantName">Detecci√≥n de Planta</h1>
    <div class="status" id="status">Inicializando IA...</div>
  </div>

  <div id="container">
    <video id="camera" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    
    <!-- Panel de datos (se posiciona din√°micamente) -->
    <div class="data-panel" id="dataPanel">
      <div class="title">üìä Datos en Vivo</div>
      <div class="data-row">
        <span class="label">Temperatura</span>
        <span class="value" id="temp">--¬∞C</span>
      </div>
      <div class="data-row">
        <span class="label">Humedad</span>
        <span class="value" id="hum">--%</span>
      </div>
      <div class="data-row">
        <span class="label">Suelo</span>
        <span class="value" id="soil">--%</span>
      </div>
      <div class="data-row">
        <span class="label">Luz</span>
        <span class="value" id="lux">-- lux</span>
      </div>
      <div class="data-row">
        <span class="label">Bater√≠a</span>
        <span class="value" id="bat">--%</span>
      </div>
    </div>
  </div>

  <div class="loading" id="loading">
    ü§ñ Cargando modelo de IA...<br>
    <small style="color: #9fb4c9; margin-top: 8px; display: block;">Esto puede tardar unos segundos</small>
  </div>

  <div class="instructions" id="instructions">
    üì∑ Apunta la c√°mara a una planta en maceta
  </div>

  <script>
    (async function() {
      // Configuraci√≥n
      const params = new URLSearchParams(location.search);
      const id = params.get('id') || 'planta01';

      // Elementos del DOM
      const video = document.getElementById('camera');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const loading = document.getElementById('loading');
      const status = document.getElementById('status');
      const dataPanel = document.getElementById('dataPanel');
      const instructions = document.getElementById('instructions');

      // Variables globales
      let model = null;
      let sensorData = null;
      let isDetecting = false;

      // Datos de fallback
      const fallbackData = {
        "name": "Planta Detectada",
        "timestamp": new Date().toISOString(),
        "sensors": { 
          "temp_c": 22.4, 
          "hum_pct": 55.0, 
          "soil_moist_pct": 40.0, 
          "lux": 700, 
          "battery_pct": 90 
        }
      };

      // Formatear n√∫meros
      function fmt(n, decimals = 1) {
        if (n === undefined || n === null || Number.isNaN(n)) return '--';
        return Number(n).toFixed(decimals);
      }

      // Actualizar datos del sensor
      function updateSensorData(data) {
        sensorData = data;
        const s = data.sensors || {};
        
        document.getElementById('plantName').textContent = data.name || 'Planta Detectada';
        document.getElementById('temp').textContent = fmt(s.temp_c) + '¬∞C';
        document.getElementById('hum').textContent = fmt(s.hum_pct) + '%';
        document.getElementById('soil').textContent = fmt(s.soil_moist_pct) + '%';
        document.getElementById('lux').textContent = (s.lux != null ? s.lux : '--') + ' lux';
        document.getElementById('bat').textContent = fmt(s.battery_pct) + '%';
      }

      // Cargar datos del JSON
      async function loadData() {
        const url = `./data/${encodeURIComponent(id)}.json`;
        try {
          const response = await fetch(url, { cache: 'no-store' });
          if (!response.ok) throw new Error(`${response.status}`);
          const data = await response.json();
          updateSensorData(data);
        } catch (err) {
          console.warn('Usando datos de fallback:', err);
          updateSensorData(fallbackData);
        }
      }

      // Iniciar c√°mara
      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            },
            audio: false
          });

          video.srcObject = stream;
          
          // Esperar a que el video est√© listo
          await new Promise(resolve => {
            video.onloadedmetadata = () => {
              video.play();
              resolve();
            };
          });

          // Ajustar canvas al tama√±o del video
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;

          console.log('‚úì C√°mara iniciada');
        } catch (err) {
          console.error('Error al acceder a la c√°mara:', err);
          status.textContent = '‚ö†Ô∏è Error: No se pudo acceder a la c√°mara';
        }
      }

      // Cargar modelo de detecci√≥n
      async function loadModel() {
        try {
          status.textContent = 'Cargando modelo de IA...';
          model = await cocoSsd.load();
          loading.classList.add('hidden');
          status.textContent = '‚úì IA lista - Buscando plantas...';
          status.classList.add('detecting');
          console.log('‚úì Modelo COCO-SSD cargado');
        } catch (err) {
          console.error('Error al cargar el modelo:', err);
          status.textContent = '‚ö†Ô∏è Error al cargar IA';
          loading.textContent = '‚ö†Ô∏è Error al cargar el modelo de IA';
        }
      }

      // Detectar objetos en el video
      async function detect() {
        if (!model || !video.videoWidth) {
          requestAnimationFrame(detect);
          return;
        }

        // Realizar detecci√≥n
        const predictions = await model.detect(video);

        // Limpiar canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Buscar plantas en las predicciones
        const plants = predictions.filter(p => 
          p.class === 'potted plant' || 
          p.class === 'vase' || 
          p.class === 'plant'
        );

        if (plants.length > 0) {
          // Encontramos al menos una planta
          const plant = plants[0]; // Usar la primera detectada
          const [x, y, width, height] = plant.bbox;

          // Dibujar bounding box
          ctx.strokeStyle = '#02eef0';
          ctx.lineWidth = 3;
          ctx.strokeRect(x, y, width, height);

          // Dibujar etiqueta
          ctx.fillStyle = '#02eef0';
          ctx.font = 'bold 16px system-ui';
          const label = `${plant.class} (${Math.round(plant.score * 100)}%)`;
          const textWidth = ctx.measureText(label).width;
          ctx.fillRect(x, y - 25, textWidth + 10, 25);
          ctx.fillStyle = '#000';
          ctx.fillText(label, x + 5, y - 7);

          // Posicionar panel de datos al lado derecho de la planta
          const panelX = Math.min(x + width + 20, window.innerWidth - 220);
          const panelY = Math.max(20, Math.min(y, window.innerHeight - 300));
          
          dataPanel.style.left = panelX + 'px';
          dataPanel.style.top = panelY + 'px';
          dataPanel.classList.add('visible');

          // Actualizar instrucciones
          instructions.textContent = '‚úÖ Planta detectada - Mostrando datos';
          instructions.style.background = 'rgba(107, 207, 127, 0.9)';

          if (!isDetecting) {
            isDetecting = true;
            status.textContent = '‚úì Planta detectada';
          }
        } else {
          // No se detect√≥ ninguna planta
          dataPanel.classList.remove('visible');
          instructions.textContent = 'üîç Buscando plantas en maceta...';
          instructions.style.background = 'rgba(2, 238, 240, 0.9)';
          
          if (isDetecting) {
            isDetecting = false;
            status.textContent = 'üîç Buscando plantas...';
          }
        }

        // Continuar detecci√≥n
        requestAnimationFrame(detect);
      }

      // Inicializar aplicaci√≥n
      async function init() {
        await startCamera();
        await loadModel();
        await loadData();
        detect(); // Iniciar loop de detecci√≥n

        // Actualizar datos cada 5 segundos
        setInterval(loadData, 5000);
      }

      // Ejecutar
      init();

    })();
  </script>

</body>
</html>