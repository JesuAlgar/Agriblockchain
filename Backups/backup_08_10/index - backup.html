<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Planta + Datos (Hotspots AR)</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root { --bg:#0b0f14; --card:#141a22; --muted:#89a2b8; --brand:#02eef0; --brand2:#1625ee; --text:#e9f1f7; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial; }
    .wrap { display:grid; grid-template-rows:auto 1fr auto; height:100%; }
    header, footer { padding:12px 16px; background:linear-gradient(90deg, #121821, #0e141b); border-bottom:1px solid #0e151d; }
    header h1 { margin:0; font-size:16px; letter-spacing:.3px; font-weight:600; }
    .content { position:relative; display:grid; grid-template-columns: 1fr min(360px, 40%); gap:12px; padding:12px; }
    .card { background:var(--card); border:1px solid #0e151d; border-radius:16px; padding:12px; }
    .kv { display:grid; grid-template-columns:auto 1fr; gap:6px 10px; font-size:14px; }
    .k { color:#9fb4c9; } .v { color:#e9f1f7; font-variant-numeric: tabular-nums; }
    .timestamp { color:#89a2b8; font-size:12px; margin-top:8px; }
    .badge { display:inline-flex; gap:6px; align-items:center; font-weight:600; padding:6px 10px; border-radius:999px; background:#0e151d; border:1px solid #1a2431; }
    .badge .dot { width:8px; height:8px; border-radius:999px; background:var(--brand); box-shadow:0 0 8px var(--brand); }
    model-viewer, .billboard {
      width: 100%; height: calc(100dvh - 170px);
      background: radial-gradient(1200px 500px at 50% 10%, #0f1722 0%, #0b0f14 60%, #0b0f14 100%);
      border-radius:16px; border:1px solid #0e151d;
      display:none;
    }
    .billboard { place-items:center; display:none; }
    .toolbar { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .btn { background:linear-gradient(90deg, var(--brand2), var(--brand)); color:#000; font-weight:700; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; }
    .btn.secondary { background:#0e151d; color:#e9f1f7; border:1px solid #1a2431; }
    footer { border-top:1px solid #0e151d; text-align:center; color:#90a7be; font-size:12px; }
    .warn { color:#ffcc66; font-size:12px; margin-top:6px; }
    .chip { background:#0e151d; border:1px solid #1a2431; color:#e9f1f7; padding:6px 10px; border-radius:10px; font-size:12px; font-weight:600; backdrop-filter: blur(4px); }
    .chip .u { color:#89a2b8; font-weight:500; margin-left:4px; }
    @media (max-width: 960px) { .content { grid-template-columns: 1fr; } model-viewer, .billboard { height: 58dvh; } }
  </style>
</head>
<body>
<div class="wrap">
  <header><h1>Planta + Datos (AR con cámara)</h1></header>
  <div class="content">
    <div class="card">
      <model-viewer id="viewer"
        src="./assets/plant.glb"
        ar ar-modes="webxr scene-viewer quick-look"
        ar-scale="fixed"
        ar-placement="floor"
        camera-controls touch-action="pan-y"
        shadow-intensity="0.6"
        environment-image="neutral"
        alt="Planta 3D">
        <button slot="ar-button" class="btn" id="enterAR">Ver en AR</button>

        <button class="chip" slot="hotspot-temp" data-position="0.25 0.40 0.10" data-normal="0 1 0">
          Temp: <span id="hsTemp">—</span><span class="u">°C</span>
        </button>
        <button class="chip" slot="hotspot-hum" data-position="0.25 0.32 0.10" data-normal="0 1 0">
          Hum: <span id="hsHum">—</span><span class="u">%</span>
        </button>
        <button class="chip" slot="hotspot-soil" data-position="0.25 0.24 0.10" data-normal="0 1 0">
          Suelo: <span id="hsSoil">—</span><span class="u">%</span>
        </button>
        <button class="chip" slot="hotspot-lux" data-position="0.25 0.16 0.10" data-normal="0 1 0">
          Luz: <span id="hsLux">—</span>
        </button>
        <button class="chip" slot="hotspot-bat" data-position="0.25 0.08 0.10" data-normal="0 1 0">
          Bat: <span id="hsBat">—</span><span class="u">%</span>
        </button>
      </model-viewer>

      <div class="billboard" id="billboard">
        <img src="./assets/plant.png" alt="Planta" style="max-width:60%; max-height:80%; object-fit:contain; display:block; margin:0 auto;"/>
      </div>

      <div class="toolbar">
        <button class="btn secondary" id="resetCam">Recentrar</button>
        <button class="btn secondary" id="toggleSpin">Auto-giro</button>
      </div>
      <div class="warn" id="warn"></div>
    </div>

    <aside class="card">
      <div class="badge"><span class="dot"></span> Sesión activa</div>
      <h3 id="plantaName" style="margin:.7rem 0 .3rem 0;">—</h3>
      <div class="timestamp" id="plantaTime">—</div>
      <div class="kv" style="margin-top:10px;">
        <div class="k">Temperatura</div><div class="v" id="vTemp">—</div>
        <div class="k">Humedad</div><div class="v" id="vHum">—</div>
        <div class="k">Suelo</div><div class="v" id="vSoil">—</div>
        <div class="k">Luz</div><div class="v" id="vLux">—</div>
        <div class="k">Batería</div><div class="v" id="vBat">—</div>
      </div>
      <div class="timestamp" id="notes" style="margin-top:10px;">—</div>
    </aside>
  </div>
  <footer>
    Abre <code>http://IP:8080/?id=planta01</code> • Pulsa "Ver en AR", detecta el suelo y coloca la planta. Los chips aparecen al lado en AR.
  </footer>
</div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const id = params.get('id') || 'planta01';

  const ui = {
    name: document.getElementById('plantaName'),
    time: document.getElementById('plantaTime'),
    vTemp: document.getElementById('vTemp'),
    vHum:  document.getElementById('vHum'),
    vSoil: document.getElementById('vSoil'),
    vLux:  document.getElementById('vLux'),
    vBat:  document.getElementById('vBat'),
    notes: document.getElementById('notes'),
    warn:  document.getElementById('warn'),
    viewer: document.getElementById('viewer'),
    billboard: document.getElementById('billboard'),
    hs: {
      temp: document.getElementById('hsTemp'),
      hum:  document.getElementById('hsHum'),
      soil: document.getElementById('hsSoil'),
      lux:  document.getElementById('hsLux'),
      bat:  document.getElementById('hsBat'),
    },
    resetCam: document.getElementById('resetCam'),
    toggleSpin: document.getElementById('toggleSpin'),
  };

  const fallbackData = {
    "name": "Demo • Fallback",
    "timestamp": new Date().toISOString(),
    "sensors": { "temp_c": 22.4, "hum_pct": 55.0, "soil_moist_pct": 40.0, "lux": 700, "battery_pct": 90 },
    "notes": "Datos locales de demostración (no se encontró el JSON remoto)."
  };

  function fmt(n, decimals=1) {
    if (n === undefined || n === null || Number.isNaN(n)) return '—';
    return Number(n).toFixed(decimals);
  }

  function populate(d) {
    ui.name.textContent = d.name || id;
    ui.time.textContent = d.timestamp ? new Date(d.timestamp).toLocaleString() : '—';
    const s = d.sensors || {};
    ui.vTemp.textContent = fmt(s.temp_c) + ' °C';
    ui.vHum.textContent  = fmt(s.hum_pct) + ' %';
    ui.vSoil.textContent = fmt(s.soil_moist_pct) + ' %';
    ui.vLux.textContent  = s.lux!=null ? String(s.lux) : '—';
    ui.vBat.textContent  = fmt(s.battery_pct) + ' %';
    ui.notes.textContent = d.notes || '';

    ui.hs.temp.textContent = fmt(s.temp_c);
    ui.hs.hum.textContent  = fmt(s.hum_pct);
    ui.hs.soil.textContent = fmt(s.soil_moist_pct);
    ui.hs.lux.textContent  = s.lux!=null ? String(s.lux) : '—';
    ui.hs.bat.textContent  = fmt(s.battery_pct);
  }

  async function loadData() {
    const url = `./data/${encodeURIComponent(id)}.json`;
    try {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      const d = await r.json();
      populate(d);
    } catch (err) {
      ui.warn.textContent = `No se pudo cargar ${url}. Usando datos de ejemplo.`;
      populate(fallbackData);
    }
  }

  async function setupVisual() {
    try {
      const head = await fetch('./assets/plant.glb', { method: 'HEAD' });
      if (head.ok) {
        ui.viewer.style.display = 'block';
        ui.billboard.style.display = 'none';
      } else {
        throw new Error('No GLB');
      }
    } catch {
      ui.viewer.style.display = 'none';
      ui.billboard.style.display = 'grid';
    }
  }

  // Fixed booleans
  let spinning = false;
  let rafId = null;
  function spin() {
    if (!spinning) return;
    const mv = ui.viewer;
    if (mv && mv.getCameraOrbit) {
      const orbit = mv.getCameraOrbit();
      const az = orbit.theta + 0.3;
      mv.cameraOrbit = `${az}deg ${orbit.phi}deg ${orbit.radius}`;
    }
    rafId = requestAnimationFrame(spin);
  }
  ui.resetCam.addEventListener('click', () => {
    if (ui.viewer) {
      ui.viewer.cameraOrbit = '0deg 65deg 100%';
      ui.viewer.fieldOfView = '45deg';
    }
  });
  ui.toggleSpin.addEventListener('click', () => {
    spinning = !spinning;
    if (spinning) { cancelAnimationFrame(rafId); spin(); }
    else { cancelAnimationFrame(rafId); }
  });

  setupVisual();
  loadData();
})();
</script>
</body>
</html>
